<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="shared-styles.html">

<dom-module id="services-view">
  <template>
    <iron-ajax id="ajaxCommunityTags"
               auto
               url="/las2peer/registry/tags"
               last-response="{{communityTags}}"
               handleAs="json"
               debounce-duration="300"></iron-ajax>
    <iron-ajax id="ajaxRegisteredServices"
               auto
               url="/las2peer/registry/services"
               last-response="{{registeredServices}}"
               handleAs="json"
               debounce-duration="300"></iron-ajax>
    <iron-ajax id="ajaxServiceReleases"
               auto
               url="/las2peer/registry/service-releases"
               last-response="{{serviceReleases}}"
               handleAs="json"
               debounce-duration="300"></iron-ajax>
    <iron-ajax id="ajaxServiceDeployments"
               auto
               url="/las2peer/registry/service-deployments"
               last-response="{{serviceDeployments}}"
               handleAs="json"
               debounce-duration="300"></iron-ajax>
    <iron-ajax id="ajaxUploadService"
               method="POST"
               url="/las2peer/services/upload"
               handle-as="json"
               on-response="_handleUploadServiceResponse"
               on-error="_handleError"
               loading = "{{_submittingUpload}}"></iron-ajax>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 0.1em;
      }
    </style>

    <div class="card">
      <h1>las2peer Services</h1>
      <h2>Registered Services</h2>
      These service names have been registered by some author on the blockchain-based service registry:
      <ul>
        <template is="dom-repeat" items="[[registeredServices]]">
          <li>[[item]]</li>
        </template>
      </ul>

      <h2>Service Releases</h2>
      These specific versions have been published:
      <ul>
        <template is="dom-repeat" items="[[_toArray(serviceReleases)]]">
          <li>[[item.name]] @
            <template is="dom-repeat" items="[[item.value]]">
              <strong>[[item.version]]</strong>
            </template>
          </li>
        </template>
      </ul>

      <h2>Service Deployments</h2>
      Running service instances on nodes in this network:
      <ul>
        <template is="dom-repeat" items="[[_toArray(serviceDeployments)]]">
          <li>[[item.name]]
            <ul>
              <template is="dom-repeat" items="[[item.value]]">
              <li>[[item.packageName]].<strong>[[item.className]]</strong> @[[item.version]]
                <ul>
                  <li>Running on Node <strong>[[item.nodeId]]</strong></li>
                  <li>Last announced at <strong>[[item.time]]</strong></li>
                </ul>
              </li>
              </template>
            </ul>
          </li>
        </template>
      </ul>

      <h2>Community Tags</h2>
      These tags currently serve no function …
      <ul>
        <template is="dom-repeat" items="[[_toArray(communityTags)]]">
        <li><strong>[[item.name]]</strong>: “[[item.value]]”</li>
        </template>
      </ul>

      <div style="display: none;">
        <!-- not needed due to registry working perfectly -->
        Enter a service name to search for published versions
        <form is="iron-form">
          <paper-input id="inputSearchname" label="service canoncial name" on-keypress="_keyPressedSearchService" autofocus value="i5.las2peer.services.fileService.FileService">
            <paper-spinner slot="suffix" active="[[_submittingSearch]]"></paper-spinner>
            <paper-icon-button slot="suffix" icon="search" on-tap="submitSearch" disabled="[[_submittingSearch]]"></paper-icon-button>
          </paper-input>
        </form>
        <template is="dom-if" if="[[_services]]">
          <h3>Known Versions</h3>
          <table width="100%">
            <tr><th>Name</th><th style="width: 5%">Version</th></tr>
            <template is="dom-repeat" items="[[_services]]">
              <tr>
                <td>[[item.name]]</td>
                <td style="padding-right: 0.5em; text-align: right">[[item.version]]</td>
              </tr>
            </template>
          </table>
        </template>
        <div id="searchServicesMsg" style="font-weight: bold"></div>
      </div>
      <h2>Upload Service</h2>
      Upload a service to the network.
      <form is="iron-form" on-keypress="_keyPressedUploadService">
        <paper-input label="service jar file" id="serviceUploadFile" disabled="[[_submittingUpload]]" type="file" required="true"></paper-input>
        <paper-button raised on-tap="uploadService" disabled="[[_submittingUpload]]">Upload Service</paper-button>
      </form>
      <div id="uploadServiceMsg" style="font-weight: bold"></div>
    </div>
  </template>
  <script>
    class ServicesView extends Polymer.Element {
      static get is() { return 'services-view'; }
      static get properties() {
        return {
          agentid: String,
          error: { type: Object, notify: true },
          _services: { type: Object },
          _submittingSearch: { type: Boolean },
          _submittingUpload: { type: Boolean }
        };
      }

      ready() {
        super.ready();
        var appThis = this;
        window.setTimeout(function() { appThis.refresh(); }, 1);
        window.setInterval(function() { appThis.refresh(); }, 5000);
      }

      refresh() {
        this.$.ajaxCommunityTags.generateRequest();
        this.$.ajaxRegisteredServices.generateRequest();
        this.$.ajaxServiceReleases.generateRequest();
        this.$.ajaxServiceDeployments.generateRequest();

      }

      _toArray(obj) {
        return Object.keys(obj).map(function(key) {
          return {
            name: key,
            value: obj[key]
          };
        });
      }

      _keyPressedUploadService(event) {
        if (event.which == 13 || event.keyCode == 13) {
          event.preventDefault();
          this.uploadService();
          return false;
        }
        return true;
      }

      uploadService(event) {
        var req = this.$.ajaxUploadService;
        req.body = new FormData();
        req.body.append('jarfile', this.$.serviceUploadFile.inputElement.inputElement.files[0]); // this is an input inside an iron-input inside a paper-input
        req.generateRequest();
      }

      _handleUploadServiceResponse(event) {
        this.$.serviceUploadFile.value = '';
        this.$.uploadServiceMsg.innerHTML = event.detail.response.msg;
      }

      _handleError(event) {
        console.log(event);
        var errorTitle = 'Error', errorMsg;
        if (event.detail.request.xhr.readyState == 4 && event.detail.request.xhr.status == 0) { // network issues
          errorTitle = 'Network Connection Error';
          errorMsg = 'Could not connect to: ' + event.detail.request.url;
        } else if (event.detail.request.xhr.response && event.detail.request.xhr.response.msg) {
          errorTitle = event.detail.request.xhr.status + " - " + event.detail.request.xhr.statusText;
          errorMsg = event.detail.request.xhr.response.msg;
        } else if (event.detail.error && event.detail.error.message) {
          errorTitle = event.detail.request.xhr.status + " - " + event.detail.request.xhr.statusText;
          errorMsg = event.detail.error.message;
        }
        if (!errorMsg) {
          errorMsg = 'An unknown error occurred. Please check console output.';
        } else {
          console.log(errorTitle + ' - ' + errorMsg);
        }
        this.error = { title: errorTitle, msg: errorMsg };
      }

    }
    customElements.define(ServicesView.is, ServicesView);
  </script>
</dom-module>
